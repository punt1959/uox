// Copyright Â© 2021 Charles Kerr. All rights reserved.
// Created on:  5/25/21

#ifndef Packet_hpp
#define Packet_hpp

#include <cstdint>
#include <string>
#include <vector>
#include <map>
#include <tuple>
#include "Buffer.hpp"
#include <memory>

struct packet_lookup {
	std::string name;
	unsigned short size ;
	packet_lookup(const std::string &name, unsigned short size) {
		this->name = name ;
		this->size = size ;
	}
};
class Player ;
class GSocket ;
class Packet : public Buffer {
protected:
	friend GSocket ;
	static const std::map<unsigned char, packet_lookup> _packet_info ;
	
	static constexpr unsigned int huffman_table[257][2] = {
		{0x002, 0x000}, {0x005, 0x01F}, {0x006, 0x022}, {0x007, 0x034}, {0x007, 0x075},
		{0x006, 0x028}, {0x006, 0x03B}, {0x007, 0x032}, {0x008, 0x0E0}, {0x008, 0x062},
		{0x007, 0x056}, {0x008, 0x079}, {0x009, 0x19D}, {0x008, 0x097}, {0x006, 0x02A},
		{0x007, 0x057}, {0x008, 0x071}, {0x008, 0x05B}, {0x009, 0x1CC}, {0x008, 0x0A7},
		{0x007, 0x025}, {0x007, 0x04F}, {0x008, 0x066}, {0x008, 0x07D}, {0x009, 0x191},
		{0x009, 0x1CE}, {0x007, 0x03F}, {0x009, 0x090}, {0x008, 0x059}, {0x008, 0x07B},
		{0x008, 0x091}, {0x008, 0x0C6}, {0x006, 0x02D}, {0x009, 0x186}, {0x008, 0x06F},
		{0x009, 0x093}, {0x00A, 0x1CC}, {0x008, 0x05A}, {0x00A, 0x1AE}, {0x00A, 0x1C0},
		{0x009, 0x148}, {0x009, 0x14A}, {0x009, 0x082}, {0x00A, 0x19F}, {0x009, 0x171},
		{0x009, 0x120}, {0x009, 0x0E7}, {0x00A, 0x1F3}, {0x009, 0x14B}, {0x009, 0x100},
		{0x009, 0x190}, {0x006, 0x013}, {0x009, 0x161},	{0x009, 0x125}, {0x009, 0x133},
		{0x009, 0x195}, {0x009, 0x173}, {0x009, 0x1CA},	{0x009, 0x086}, {0x009, 0x1E9},
		{0x009, 0x0DB}, {0x009, 0x1EC}, {0x009, 0x08B}, {0x009, 0x085}, {0x005, 0x00A},
		{0x008, 0x096}, {0x008, 0x09C}, {0x009, 0x1C3}, {0x009, 0x19C}, {0x009, 0x08F},
		{0x009, 0x18F}, {0x009, 0x091}, {0x009, 0x087}, {0x009, 0x0C6}, {0x009, 0x177},
		{0x009, 0x089}, {0x009, 0x0D6}, {0x009, 0x08C}, {0x009, 0x1EE}, {0x009, 0x1EB},
		{0x009, 0x084}, {0x009, 0x164}, {0x009, 0x175},	{0x009, 0x1CD}, {0x008, 0x05E},
		{0x009, 0x088}, {0x009, 0x12B}, {0x009, 0x172}, {0x009, 0x10A}, {0x009, 0x08D},
		{0x009, 0x13A}, {0x009, 0x11C}, {0x00A, 0x1E1},	{0x00A, 0x1E0}, {0x009, 0x187},
		{0x00A, 0x1DC}, {0x00A, 0x1DF}, {0x007, 0x074}, {0x009, 0x19F}, {0x008, 0x08D},
		{0x008, 0x0E4}, {0x007, 0x079}, {0x009, 0x0EA}, {0x009, 0x0E1}, {0x008, 0x040},
		{0x007, 0x041}, {0x009, 0x10B}, {0x009, 0x0B0}, {0x008, 0x06A}, {0x008, 0x0C1},
		{0x007, 0x071}, {0x007, 0x078}, {0x008, 0x0B1}, {0x009, 0x14C}, {0x007, 0x043},
		{0x008, 0x076}, {0x007, 0x066}, {0x007, 0x04D}, {0x009, 0x08A}, {0x006, 0x02F},
		{0x008, 0x0C9}, {0x009, 0x0CE}, {0x009, 0x149},	{0x009, 0x160}, {0x00A, 0x1BA},
		{0x00A, 0x19E}, {0x00A, 0x39F}, {0x009, 0x0E5}, {0x009, 0x194}, {0x009, 0x184},
		{0x009, 0x126}, {0x007, 0x030}, {0x008, 0x06C}, {0x009, 0x121}, {0x009, 0x1E8},
		{0x00A, 0x1C1}, {0x00A, 0x11D}, {0x00A, 0x163}, {0x00A, 0x385}, {0x00A, 0x3DB},
		{0x00A, 0x17D}, {0x00A, 0x106}, {0x00A, 0x397}, {0x00A, 0x24E}, {0x007, 0x02E},
		{0x008, 0x098}, {0x00A, 0x33C}, {0x00A, 0x32E}, {0x00A, 0x1E9}, {0x009, 0x0BF},
		{0x00A, 0x3DF}, {0x00A, 0x1DD}, {0x00A, 0x32D}, {0x00A, 0x2ED}, {0x00A, 0x30B},
		{0x00A, 0x107}, {0x00A, 0x2E8}, {0x00A, 0x3DE}, {0x00A, 0x125}, {0x00A, 0x1E8},
		{0x009, 0x0E9}, {0x00A, 0x1CD}, {0x00A, 0x1B5}, {0x009, 0x165}, {0x00A, 0x232},
		{0x00A, 0x2E1}, {0x00B, 0x3AE}, {0x00B, 0x3C6}, {0x00B, 0x3E2}, {0x00A, 0x205},
		{0x00A, 0x29A}, {0x00A, 0x248}, {0x00A, 0x2CD}, {0x00A, 0x23B}, {0x00B, 0x3C5},
		{0x00A, 0x251}, {0x00A, 0x2E9}, {0x00A, 0x252}, {0x009, 0x1EA}, {0x00B, 0x3A0},
		{0x00B, 0x391}, {0x00A, 0x23C}, {0x00B, 0x392}, {0x00B, 0x3D5}, {0x00A, 0x233},
		{0x00A, 0x2CC}, {0x00B, 0x390}, {0x00A, 0x1BB}, {0x00B, 0x3A1}, {0x00B, 0x3C4},
		{0x00A, 0x211}, {0x00A, 0x203}, {0x009, 0x12A}, {0x00A, 0x231}, {0x00B, 0x3E0},
		{0x00A, 0x29B}, {0x00B, 0x3D7}, {0x00A, 0x202}, {0x00B, 0x3AD}, {0x00A, 0x213},
		{0x00A, 0x253}, {0x00A, 0x32C}, {0x00A, 0x23D}, {0x00A, 0x23F}, {0x00A, 0x32F},
		{0x00A, 0x11C}, {0x00A, 0x384}, {0x00A, 0x31C}, {0x00A, 0x17C}, {0x00A, 0x30A},
		{0x00A, 0x2E0}, {0x00A, 0x276}, {0x00A, 0x250}, {0x00B, 0x3E3}, {0x00A, 0x396},
		{0x00A, 0x18F}, {0x00A, 0x204}, {0x00A, 0x206}, {0x00A, 0x230}, {0x00A, 0x265},
		{0x00A, 0x212}, {0x00A, 0x23E}, {0x00B, 0x3AC}, {0x00B, 0x393}, {0x00B, 0x3E1},
		{0x00A, 0x1DE}, {0x00B, 0x3D6}, {0x00A, 0x31D}, {0x00B, 0x3E5}, {0x00B, 0x3E4},
		{0x00A, 0x207}, {0x00B, 0x3C7}, {0x00A, 0x277}, {0x00B, 0x3D4}, {0x008, 0x0C0},
		{0x00A, 0x162}, {0x00A, 0x3DA}, {0x00A, 0x124}, {0x00A, 0x1B4}, {0x00A, 0x264},
		{0x00A, 0x33D}, {0x00A, 0x1D1}, {0x00A, 0x1AF}, {0x00A, 0x39E}, {0x00A, 0x24F},
		{0x00B, 0x373}, {0x00A, 0x249}, {0x00B, 0x372}, {0x009, 0x167}, {0x00A, 0x210},
		{0x00A, 0x23A}, {0x00A, 0x1B8}, {0x00B, 0x3AF}, {0x00A, 0x18E}, {0x00A, 0x2EC},
		{0x007, 0x62}, {0x004, 0x0D}
	};
	unsigned char  _id ;
	std::string _name ;
	std::weak_ptr<Player> _myplayer ;
	std::string _creation_time ;
	bool _variable;
	std::string _buffer_description;
	
public:
	static std::shared_ptr<Packet> createPacket(unsigned char id);
	static std::tuple<unsigned short, std::string> infoPacket(unsigned char packetid);
	Packet(unsigned char id) ;
	virtual ~Packet() = default;
	bool variable() const { return _variable;}
	std::string name() const { return _name;}
	unsigned char id() const ;
	std::vector<unsigned char> applyHuffman() const ;
	void zip(std::vector<unsigned char> &source, std::vector<unsigned char> &dest);
	std::string description() const ;
	std::size_t size() ;
	unsigned char* data() ;
	virtual void finalize() ;
};

#endif /* Packet_hpp */
